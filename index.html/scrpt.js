const POEMAS_DATA = [
    { id: 's1', titulo: 'O Pre√ßo da Tua Nega√ß√£o', conteudo: `Vi-te naquele canto,\na boca perdida na dele,\ncomo se o mundo n√£o conhecesse\nos segredos que deixaste marcados em mim.\nViraste o rosto, com aquela frieza ensaiada,\ne disseste:\n‚ÄúSomos amigos. Nada mais.‚Äù\n\nCurioso.\nTamb√©m √©ramos s√≥ isso ontem?\nOntem, quando tua l√≠ngua procurava a minha\ncom a fome de quem esqueceu o pr√≥prio nome?\nQuando a luz vermelha tremulava no quarto\ncomo uma testemunha c√∫mplice,\nvendo teus gemidos atravessarem meu peito\ncomo l√¢mina quente?\n\nChamarias de amizade\no jeito como tu tremias\nquando minha m√£o te puxava pela cintura,\ncomo se todo o desejo do teu corpo\ntivesse encontrado finalmente\no lugar onde morava?\n\nE quando eu te observava ‚Äî\ntodos os dias,\ntodos os segundos ‚Äî\ne tu me devolvias o olhar\ncom aquele brilho que negas agora,\n√©ramos amigos ali tamb√©m?\nNa troca de confiss√µes,\nno riso,\nno reino √≠ntimo que s√≥ existe\nquando dois corpos j√° se conhecem demais?\n\nDizes ‚Äúamigos‚Äù.\nMas fomos isso\nquando tra√≠ste teu namorado comigo?\nQuando tu mesma escolheste atravessar essa fronteira\ncom tua boca colada na minha,\ncom o teu desejo queimando na pele?\n\nE fomos amigos\nquando bebeste do meu gozo,\ncomo quem bebe a verdade proibida?\nFomos amigos\nquando me ligavas de madrugada,\ncom a voz tr√™mula,\npedindo que eu fosse at√© a√≠\nporque tu queria foder\ncomo se o mundo estivesse prestes a explodir?\n\nDizes ‚Äúamizade‚Äù\npra n√£o encarar o inc√™ndio que tu mesma acendeu.\n\nVem.\nTu sabes.\nTeu desejo tem o meu nome grafado nele\ndesde antes de admitires.\nN√£o te destruas fingindo indiferen√ßa,\nn√£o apagues com desculpas\no que teu corpo escreve h√° anos.\n\nAproxima-te.\nSeja minha, deixe que eu seja teu,\nTu √©s a minha princesa.` },
    { id: 's2', titulo: 'O sussurro do abismo', conteudo: `\nEra como se eu fosse uma folha,\npresa a um galho fr√°gil em tempestade,\no vento rugia, feroz e indiferente,\ne eu, cansada de lutar, entreguei-me ao vazio.\n\nMeu sangue, outrora rio da vida,\ntornou-se um riacho silencioso que escorria,\ntingindo a terra com sua cor rubra,\ncomo um outono que nunca v√™ a primavera.\n\nNa vastid√£o do universo,\nfui um gr√£o de areia que o mar esqueceu,\num lampejo apagado por sombras densas,\nmenos que o sussurro de estrelas mortas.\n\nQuando o abismo abriu seus bra√ßos,\nn√£o houve lamento, nem resgate,\napenas a queda suave, o sil√™ncio eterno,\ne a certeza de que at√© o nada era mais do que eu.\n` },
    { id: 's3', titulo: 'Onde te perdi', conteudo: `Diga-me, onde foi que eu vos perdi,\nOnde tu me deixaste para buscar outro olhar?\nOnde foi que os caminhos se separaram,\nE tu encontraste nele o que em mim n√£o viste mais?\n\nDiga-me, onde tu o beijaste escondida,\nOnde tu te entregaste a ele,\nEsquecendo os la√ßos que outrora uniam nossas almas,\nOnde ficou o juramento que fizemos de nunca nos deixar?\n\nDiga-me, ele te faz feliz?\nEle te preenche o vazio que eu deixei sem querer?\nEu, que ainda busco respostas nas sombras,\nE tu, que te perdes na luz de um novo amor.\n\nOnde me perdi de ti, amor?\nOnde ficou a promessa, o sentimento que nos moldava?\nOnde encontraste nele aquilo que eu n√£o soube ser,\nE por que, ao inv√©s de me procurar, foste √† busca de um outro caminho?\n` },
    { id: 's4', titulo: 'Amor em ru√≠nas', conteudo: `\nQuando tu partiste,\nOs sonhos viraram pesadelos repetidos,\nPor meses vi teu rosto em cada canto,\nE o vazio no meu peito crescia, incontrol√°vel.\n\nPassei duas semanas em agonia,\nSem for√ßa para alimentar o corpo,\nApenas a √°gua lavava minha garganta,\nEnquanto cada refei√ß√£o voltava como minha dor.\n\nAcordava em madrugadas geladas,\nO peito sufocado por gritos sem som,\nAs crises me abra√ßavam como tu jamais fizeste,\nE onde estavas, enquanto eu me desfazia?\n\nDeixaste-me nesse abismo sem olhar para tr√°s,\nTua aus√™ncia queimava mais que qualquer adeus,\nE, ainda assim, com todo esse peso em mim,\nEu te amo‚Ä¶ porque amar-te √© a minha maldi√ß√£o.\n` },
    { id: 's5', titulo: 'O fardo do amor n√£o correspondido', conteudo: `\nVoc√™ diz ser a v√≠tima,\nClama que sofreu,\nMas foi no colo dele que se aconchegou,\nBeijando-o com os mesmos l√°bios que um dia foram meus,\nDizendo palavras que j√° n√£o t√™m valor,\nEnquanto eu, destro√ßado, assistia, em sil√™ncio,\nA dor de ver o amor que eu criei sendo esquecido,\nSem sequer uma explica√ß√£o.\n\nEu vi voc√™ se entregando a ele,\nE eu me pergunto, quando foi que tu paraste de me amar?\nQuando o fio que nos ligava se partiu sem que eu percebesse?\nQuando o amor que eu acreditava eterno virou poeira no vento?\n\nEscolheste ele, escolheste viver ao lado dele,\nEscolheste construir uma nova vida com ele,\nColocando o nome que eu sonhei para nosso filho,\nComo se minhas mem√≥rias n√£o importassem mais.\n\nParte de mim se perdeu nesse v√°cuo,\nUm vazio que n√£o consegue ser preenchido por palavras,\nE tudo que me resta √© essa pergunta que ecoa:\nQuando deixaste de me amar, se √© que um dia me amaste de verdade?\n\nEu disse ‚Äúeu te odeio‚Äù enquanto o buqu√™ ca√≠a,\nMas a dor de te perder transbordava mais que qualquer raiva.
E voc√™, com um sorriso insens√≠vel, disse:\n‚ÄúEu tamb√©m estou sofrendo.‚Äù\nMas onde? Onde est√° o sofrimento, se n√£o o meu?\n` },
    { id: 's6', titulo: 'eco da aus√™ncia', conteudo: `\nMurmuro que desejo esquecer-te,\nMas em verdade, anseio perder-me em ti.\nN√£o almejo apagar-te da mem√≥ria,\nQuero-te, inteira, esculpida em minha hist√≥ria.\n\nAh, fosse o amor simples como narram,\nPor√©m a simplicidade √© alheia ao cora√ß√£o.\nO peso dos sentimentos ocultos arde,\nUm fogo que n√£o consome, mas esmaga.\n` },
    { id: 's7', titulo: 'Desespero do Desejo', conteudo: `\nQuerida, eu quero beijar-te,\nBeijar cada parte de tua alma,\nDeixar o toque das minhas m√£os\nTra√ßar o caminho que os teus l√°bios percorrem.\n\nSeja minha, pois sem ti sou vazio,\nTeu olhar me devora, me consome,\nE em cada instante, eu imploro,\nQue possas ser s√≥ minha, eternamente.\n\nMas em meu peito, o medo se esconde,\nO medo de n√£o te ter, de te perder.\nMas eu n√£o posso viver sem ti,\nEnt√£o, por favor, seja minha, s√≥ minha.\n` },
    { id: 's8', titulo: 'O Clamor do Amor', conteudo: `\nSeja minha e eu serei teu,\nNo sil√™ncio do nosso querer,\nOnde os corpos se encontram e se completam,\nEu serei a √¢ncora que te mant√©m, a chama que te aquece.\n\nEntregue-se, pois a entrega √© o nosso destino,\nDeixe que eu cuide de ti, como a terra cuida da semente,\nCom o carinho do vento que embala a folha,\nE o sol que se p√µe para jamais se ausentar.\n\nTu n√£o v√™s que eu te amo?\nCada gesto meu grita em sil√™ncio,\nCada olhar que lan√ßa a saudade,\nTudo em mim √© s√≥ teu, eternamente teu.\n` }
];

const { createApp, ref, computed, onMounted, nextTick, reactive, watch } = Vue;

createApp({
    setup() {
        const isMenuOpen = ref(false);
        const activeSection = ref('home');
        const isAudioPlaying = ref(false);
        const isFeedbackModalOpen = ref(false);
        const feedbackForm = reactive({ name: '', email: '', message: '' });
        const copyBtnText = ref('üìã Toque aqui para copiar tudo');
        
        // Vari√°veis novas para recursos extras
        const beatsLost = ref(0);
        const toastVisible = ref(false);
        const toastMessage = ref('');
        
        let audioCtx = null;
        let beatInterval = null;
        let lifeInterval = null;
        let observer = null;

        const poemas = computed(() => POEMAS_DATA);
        const activePoema = computed(() => {
            if (activeSection.value === 'home') return null;
            return poemas.value.find(p => p.id === activeSection.value);
        });
        const isHomeActive = computed(() => activeSection.value === 'home');
        
        // Computed para √çndice e Navega√ß√£o
        const currentIndex = computed(() => {
            if (!activePoema.value) return -1;
            return poemas.value.findIndex(p => p.id === activePoema.value.id);
        });

        // Divide o poema em linhas para o efeito de scroll reveal
        const formattedPoemLines = computed(() => {
            if (!activePoema.value) return [];
            return activePoema.value.conteudo.split('\n');
        });
        
        // Configura o IntersectionObserver para animar as linhas
        const setupScrollReveal = () => {
            if (observer) observer.disconnect();
            
            observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target); // Anima apenas uma vez
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px' // Ativa um pouco antes do fim da tela
            });

            const lines = document.querySelectorAll('.poem-line');
            lines.forEach(line => observer.observe(line));
        };

        // Observa mudan√ßas no poema ativo para reiniciar a anima√ß√£o e scroll
        watch(activePoema, () => {
            if (activePoema.value) {
                copyBtnText.value = 'üìã Toque aqui para copiar tudo';
                nextTick(() => {
                    setupScrollReveal();
                    const target = document.querySelector(".poesia-section");
                    if (target) target.scrollTo(0, 0); 
                });
            }
        });
        
        // Fun√ß√£o para copiar apenas o verso clicado
        const copyVerse = async (line) => {
            if (!line || line.trim() === '') return;
            try {
                await navigator.clipboard.writeText(line);
                showToast("Verso copiado para a √°rea de transfer√™ncia.");
            } catch (err) {
                console.error("Erro ao copiar verso", err);
            }
        };

        // Exibe notifica√ß√£o tempor√°ria
        const showToast = (msg) => {
            toastMessage.value = msg;
            toastVisible.value = true;
            setTimeout(() => {
                toastVisible.value = false;
            }, 3000);
        };

        // Contador de "Vida Gasta"
        const startLifeCounter = () => {
            // Batimento em repouso ~800ms. Se √°udio ligado (130bpm) ~461ms
            if (lifeInterval) clearInterval(lifeInterval);
            const speed = isAudioPlaying.value ? 461 : 800;
            lifeInterval = setInterval(() => {
                beatsLost.value++;
            }, speed);
        };

        const playHeartbeatSound = () => {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            
            const oscLow = audioCtx.createOscillator();
            const gainLow = audioCtx.createGain();
            oscLow.connect(gainLow);
            gainLow.connect(audioCtx.destination);
            oscLow.frequency.setValueAtTime(60, t);
            oscLow.frequency.exponentialRampToValueAtTime(45, t + 0.1);
            gainLow.gain.setValueAtTime(0, t);
            gainLow.gain.linearRampToValueAtTime(1.0, t + 0.02); 
            gainLow.gain.exponentialRampToValueAtTime(0.01, t + 0.35);
            oscLow.start(t);
            oscLow.stop(t + 0.4);

            const oscHigh = audioCtx.createOscillator();
            const gainHigh = audioCtx.createGain();
            oscHigh.connect(gainHigh);
            gainHigh.connect(audioCtx.destination);
            oscHigh.frequency.setValueAtTime(140, t);
            oscHigh.frequency.exponentialRampToValueAtTime(80, t + 0.05);
            gainHigh.gain.setValueAtTime(0, t);
            gainHigh.gain.linearRampToValueAtTime(0.4, t + 0.01);
            gainHigh.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
            oscHigh.start(t);
            oscHigh.stop(t + 0.15);
        };
        
        const triggerLightning = () => {
            const layer = document.getElementById('lightning-layer');
            if (layer) {
                layer.classList.add('flash');
                setTimeout(() => {
                    layer.classList.remove('flash');
                }, 150);
            }
            const nextTime = Math.random() * 10000 + 5000;
            setTimeout(triggerLightning, nextTime);
        };

        const toggleAudio = () => {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            isAudioPlaying.value = !isAudioPlaying.value;
            
            // Ajusta velocidade do contador de vida baseada na "adrenalina" do √°udio
            startLifeCounter();

            if (isAudioPlaying.value) {
                playHeartbeatSound(); 
                beatInterval = setInterval(playHeartbeatSound, 461);
            } else {
                clearInterval(beatInterval);
                beatInterval = null;
            }
        };

        const toggleMenu = () => {
            isMenuOpen.value = !isMenuOpen.value;
        };

        const handleHashChange = () => {
            const hash = window.location.hash.slice(1);
            if (hash && poemas.value.some(p => p.id === hash)) {
                activeSection.value = hash;
            } else {
                activeSection.value = 'home';
            }
        };

        const showSection = (id) => {
            if (id === 'home') {
                history.pushState(null, null, ' '); 
                handleHashChange(); 
            } else {
                window.location.hash = id; 
            }
            isMenuOpen.value = false;
        };

        const prevPoem = () => {
            if (currentIndex.value === -1) return;
            let newIndex = currentIndex.value - 1;
            if (newIndex < 0) newIndex = poemas.value.length - 1;
            showSection(poemas.value[newIndex].id);
        };

        const nextPoem = () => {
            if (currentIndex.value === -1) return;
            let newIndex = currentIndex.value + 1;
            if (newIndex >= poemas.value.length) newIndex = 0;
            showSection(poemas.value[newIndex].id);
        };

        const openRandomPoem = () => {
            const randomIndex = Math.floor(Math.random() * poemas.value.length);
            showSection(poemas.value[randomIndex].id);
        };

        const openFeedbackModal = () => {
            isFeedbackModalOpen.value = true;
            isMenuOpen.value = false;
        };

        const closeFeedbackModal = () => {
            isFeedbackModalOpen.value = false;
        };

        const sendFeedback = () => {
            const subject = encodeURIComponent("Opini√£o sobre o site Poesias");
            const body = encodeURIComponent(`Nome: ${feedbackForm.name}\nEmail: ${feedbackForm.email}\n\nMensagem:\n${feedbackForm.message}`);
            window.location.href = `mailto:renancodando@gmail.com?subject=${subject}&body=${body}`;
            closeFeedbackModal();
            feedbackForm.name = '';
            feedbackForm.email = '';
            feedbackForm.message = '';
        };
        
        const copyFullPoem = async () => {
            if (!activePoema.value) return;
            try {
                await navigator.clipboard.writeText(activePoema.value.conteudo);
                showToast("Poema completo copiado com sucesso!");
            } catch (err) {
                console.error('Erro ao copiar', err);
                showToast("Erro ao copiar.");
            }
        };

        onMounted(() => {
            handleHashChange();
            window.addEventListener("hashchange", handleHashChange);
            
            if (activePoema.value) {
                nextTick(setupScrollReveal);
            }
            
            setTimeout(triggerLightning, 3000);
            startLifeCounter(); // Inicia o contador de vida

            document.addEventListener("click", (e) => {
                const menuWrapper = document.querySelector(".topnav");
                if (isMenuOpen.value && menuWrapper && !menuWrapper.contains(e.target)) {
                    isMenuOpen.value = false;
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (isMenuOpen.value) isMenuOpen.value = false;
                    if (isFeedbackModalOpen.value) isFeedbackModalOpen.value = false;
                }
            });
        });

        return {
            isMenuOpen,
            activeSection,
            activePoema,
            isHomeActive,
            isAudioPlaying,
            isFeedbackModalOpen,
            feedbackForm,
            formattedPoemLines,
            copyBtnText,
            beatsLost,
            toastVisible,
            toastMessage,
            toggleAudio,
            showSection,
            toggleMenu,
            playHeartbeatSound,
            openFeedbackModal,
            closeFeedbackModal,
            sendFeedback,
            copyFullPoem,
            copyVerse,
            openRandomPoem,
            poemas,
            prevPoem,
            nextPoem
        };
    }
}).mount('#app');

const canvas = document.getElementById('particle-canvas');
const ctx = canvas.getContext('2d');
let particles = [];
// Otimiza√ß√£o: Ajusta n√∫mero de part√≠culas baseado na largura da tela
const numParticles = window.innerWidth < 600 ? 60 : 150; 

const darkThemeColors = {
    red: (alpha) => `rgba(${Math.floor(Math.random() * 100) + 150}, 0, 0, ${alpha})`,
    blue: (alpha) => `rgba(200, 200, 255, ${alpha})`
};

function Particle(x, y, color, speedY, size) {
    this.x = x;
    this.y = y;
    this.color = color;
    this.speedY = speedY;
    this.size = size;
}

Particle.prototype.update = function() {
    this.y += this.speedY;
    if (this.y > canvas.height) {
        this.y = -this.size;
        this.x = Math.random() * canvas.width;
    }
};

Particle.prototype.draw = function() {
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
};

function initParticles() {
    // Otimiza√ß√£o: Usa largura da janela direta, ignorando Device Pixel Ratio para background
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    particles = [];
    for (let i = 0; i < numParticles; i++) {
        const x = Math.random() * canvas.width;
        const y = Math.random() * canvas.height;
        const size = Math.random() * 1.5 + 0.5;
        const speedY = Math.random() * 2.0 + 1.0; 
        let color;
        if (Math.random() > 0.6) {
            color = darkThemeColors.red(Math.random() * 0.5 + 0.3);
        } else {
            color = darkThemeColors.blue(Math.random() * 0.7 + 0.3);
        }
        particles.push(new Particle(x, y, color, speedY, size));
    }
}

function animateCanvas() {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    for (let i = 0; i < particles.length; i++) {
        particles[i].update();
        particles[i].draw();
    }
    requestAnimationFrame(animateCanvas);
}

window.addEventListener('resize', initParticles);
initParticles();
animateCanvas();